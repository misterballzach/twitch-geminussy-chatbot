<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Bot Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #5b21b6; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="range"] { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; }
        button { background-color: #5b21b6; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #4c1d95; }
        #logs { margin-top: 20px; background: #eee; padding: 10px; border-radius: 4px; height: 200px; overflow-y: scroll; }
        .log-message { font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gemini Twitch Bot Dashboard</h1>
        <div class="form-group">
            <label for="personality">Personality:</label>
            <input type="text" id="personality" value="{{ personality }}">
        </div>
        <div class="form-group">
            <label for="freq">Auto Chat Frequency: <span id="freq_val">{{ auto_chat_freq }}</span></label>
            <input type="range" id="freq" min="0" max="1" step="0.01" value="{{ auto_chat_freq }}">
        </div>
        <div class="form-group">
            <label for="say_msg">Send !say Message:</label>
            <input type="text" id="say_msg">
            <button onclick="sendMessage()">Send</button>
        </div>
        <div class="form-group">
            <h2>Live Context</h2>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h3>Recent Chat</h3>
                    <div id="chat-logs" style="height: 300px; overflow-y: scroll; background: #eee; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap;"></div>
                </div>
                <div style="flex: 1;">
                    <h3>Captions</h3>
                    <div id="caption-logs" style="height: 300px; overflow-y: scroll; background: #eee; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap;"></div>
                </div>
            </div>
        </div>
        <div id="logs">
            <div class="log-message">Dashboard loaded.</div>
        </div>
        <div class="form-group">
            <h2>Socials</h2>
            <div id="socials-container">
                <!-- Socials will be dynamically added here -->
            </div>
            <button onclick="addSocial()">Add Social</button>
            <button onclick="saveSocials()">Save Socials</button>
        </div>
        <div class="form-group">
            <h2>Commands</h2>
            <ul id="commands-list">
                <!-- Commands will be dynamically added here -->
            </ul>
        </div>
        <div class="form-group">
            <h2>Personality Traits</h2>
            <div id="personality-traits-container">
                <div>
                    <label for="likes">Likes (comma-separated):</label>
                    <input type="text" id="likes">
                </div>
                <div>
                    <label for="dislikes">Dislikes (comma-separated):</label>
                    <input type="text" id="dislikes">
                </div>
                <button onclick="savePersonalityTraits()">Save Personality Traits</button>
            </div>
        </div>
        <div class="form-group">
            <h2>User Explorer</h2>
            <div id="user-explorer-container">
                <!-- User data will be dynamically added here -->
            </div>
            <button onclick="refreshUserData()">Refresh User Data</button>
        </div>
        <div class="form-group">
            <h2>Response Settings</h2>
            <div id="response-settings-container">
                <div>
                    <label for="max-response-length">Max Response Length (characters):</label>
                    <input type="number" id="max-response-length">
                </div>
                <button onclick="saveResponseSettings()">Save Response Settings</button>
            </div>
        </div>
        <div class="form-group">
            <h2>Conversation Starter</h2>
            <div id="conversation-starter-container">
                <div>
                    <label for="conversation-starter">Enable Conversation Starter:</label>
                    <input type="checkbox" id="conversation-starter">
                </div>
                <div>
                    <label for="conversation-starter-interval">Interval (seconds):</label>
                    <input type="number" id="conversation-starter-interval">
                </div>
                <button onclick="saveConversationStarterSettings()">Save Settings</button>
            </div>
        </div>
        <div class="form-group">
            <h2>Delay Settings</h2>
            <div id="delay-settings-container">
                <div>
                    <label for="base-delay">Base Delay (seconds):</label>
                    <input type="number" id="base-delay" step="0.1">
                </div>
                <div>
                    <label for="delay-per-character">Delay Per Character (seconds):</label>
                    <input type="number" id="delay-per-character" step="0.01">
                </div>
                <button onclick="saveDelaySettings()">Save Delay Settings</button>
            </div>
        </div>
        <div class="form-group">
            <h2>Moderation</h2>
            <div id="moderation-container">
                <div>
                    <label for="banned-words">Banned Words (comma-separated):</label>
                    <input type="text" id="banned-words">
                </div>
                <div>
                    <label for="link-filtering">Link Filtering:</label>
                    <input type="checkbox" id="link-filtering">
                </div>
                <div>
                    <label for="caps-filtering">Caps Filtering:</label>
                    <input type="checkbox" id="caps-filtering">
                </div>
                <div>
                    <label for="timeout-duration">Timeout Duration (seconds):</label>
                    <input type="number" id="timeout-duration">
                </div>
                <button onclick="saveModeration()">Save Moderation Settings</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();

        const personalityInput = document.getElementById("personality");
        const freqInput = document.getElementById("freq");
        const freqVal = document.getElementById("freq_val");
        const logsContainer = document.getElementById("logs");
        const socialsContainer = document.getElementById("socials-container");
        const commandsList = document.getElementById("commands-list");
        const bannedWordsInput = document.getElementById("banned-words");
        const linkFilteringCheckbox = document.getElementById("link-filtering");
        const capsFilteringCheckbox = document.getElementById("caps-filtering");
        const timeoutDurationInput = document.getElementById("timeout-duration");
        const likesInput = document.getElementById("likes");
        const dislikesInput = document.getElementById("dislikes");
        const userExplorerContainer = document.getElementById("user-explorer-container");
        const baseDelayInput = document.getElementById("base-delay");
        const delayPerCharacterInput = document.getElementById("delay-per-character");
        const maxResponseLengthInput = document.getElementById("max-response-length");
        const conversationStarterCheckbox = document.getElementById("conversation-starter");
        const conversationStarterIntervalInput = document.getElementById("conversation-starter-interval");

        freqInput.addEventListener("input", () => {
            freqVal.innerText = freqInput.value;
            updateConfig();
        });

        personalityInput.addEventListener("change", updateConfig);

        function updateConfig() {
            socket.emit("update_config", {
                personality: personalityInput.value,
                auto_chat_freq: parseFloat(freqInput.value)
            });
        }

        function sendMessage() {
            const msg = document.getElementById("say_msg").value;
            if(msg) {
                socket.emit("send_message", {message: msg});
                document.getElementById("say_msg").value = "";
            }
        }

        function addLog(message) {
            const logElement = document.createElement("div");
            logElement.className = "log-message";
            logElement.textContent = message;
            logsContainer.appendChild(logElement);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        socket.on("config_updated", (config) => {
            personalityInput.value = config.personality;
            freqInput.value = config.auto_chat_freq;
            freqVal.innerText = config.auto_chat_freq;

            // Populate moderation settings
            const moderation = config.moderation || {};
            bannedWordsInput.value = (moderation.banned_words || []).join(", ");
            linkFilteringCheckbox.checked = moderation.link_filtering;
            capsFilteringCheckbox.checked = moderation.caps_filtering;
            timeoutDurationInput.value = moderation.timeout_duration;

            // Populate personality traits
            const personalityTraits = config.personality_traits || {};
            likesInput.value = (personalityTraits.likes || []).join(", ");
            dislikesInput.value = (personalityTraits.dislikes || []).join(", ");

            // Populate delay settings
            const delaySettings = config.delay_settings || {};
            baseDelayInput.value = delaySettings.base_delay;
            delayPerCharacterInput.value = delaySettings.delay_per_character;

            // Populate response settings
            maxResponseLengthInput.value = config.max_response_length;

            // Populate conversation starter settings
            const conversationStarter = config.conversation_starter || {};
            conversationStarterCheckbox.checked = conversationStarter.enabled;
            conversationStarterIntervalInput.value = conversationStarter.interval;

            addLog("Config updated.");
        });

        // Initial population
        const initialSocials = JSON.parse('{{ socials | safe }}');
        for (const [platform, link] of Object.entries(initialSocials)) {
            const socialDiv = document.createElement("div");
            socialDiv.innerHTML = `<input type="text" value="${platform}" class="social-platform" placeholder="Platform"> <input type="text" value="${link}" class="social-link" placeholder="Link">`;
            socialsContainer.appendChild(socialDiv);
        }

        const initialCommands = JSON.parse('{{ commands | safe }}');
        console.log("Initial commands:", initialCommands);
        for (const command of initialCommands) {
            const li = document.createElement("li");
            li.textContent = `!${command}`;
            commandsList.appendChild(li);
        }

        const initialModeration = JSON.parse('{{ moderation | safe }}');
        bannedWordsInput.value = (initialModeration.banned_words || []).join(", ");
        linkFilteringCheckbox.checked = initialModeration.link_filtering;
        capsFilteringCheckbox.checked = initialModeration.caps_filtering;
        timeoutDurationInput.value = initialModeration.timeout_duration;

        function addSocial() {
            const socialDiv = document.createElement("div");
            socialDiv.innerHTML = `<input type="text" class="social-platform" placeholder="Platform"> <input type="text" class="social-link" placeholder="Link">`;
            socialsContainer.appendChild(socialDiv);
        }

        function saveSocials() {
            const socials = {};
            const socialDivs = socialsContainer.querySelectorAll("div");
            socialDivs.forEach(div => {
                const platform = div.querySelector(".social-platform").value;
                const link = div.querySelector(".social-link").value;
                if (platform && link) {
                    socials[platform] = link;
                }
            });
            socket.emit("update_socials", {socials: socials});
        }

        function saveModeration() {
            const moderation = {
                banned_words: bannedWordsInput.value.split(",").map(word => word.trim()).filter(word => word),
                link_filtering: linkFilteringCheckbox.checked,
                caps_filtering: capsFilteringCheckbox.checked,
                timeout_duration: parseInt(timeoutDurationInput.value)
            };
            socket.emit("update_moderation", {moderation: moderation});
        }

        function savePersonalityTraits() {
            const personalityTraits = {
                likes: likesInput.value.split(",").map(word => word.trim()).filter(word => word),
                dislikes: dislikesInput.value.split(",").map(word => word.trim()).filter(word => word)
            };
            socket.emit("update_personality_traits", {personality_traits: personalityTraits});
        }

        function saveDelaySettings() {
            const delaySettings = {
                base_delay: parseFloat(baseDelayInput.value),
                delay_per_character: parseFloat(delayPerCharacterInput.value)
            };
            socket.emit("update_delay_settings", {delay_settings: delaySettings});
        }

        function saveResponseSettings() {
            const responseSettings = {
                max_response_length: parseInt(maxResponseLengthInput.value)
            };
            socket.emit("update_response_settings", {response_settings: responseSettings});
        }

        function refreshUserData() {
            socket.emit("get_user_data");
        }

        socket.on("user_data", (data) => {
            userExplorerContainer.innerHTML = "";
            const table = document.createElement("table");
            table.innerHTML = `
                <tr>
                    <th>Username</th>
                    <th>Message Count</th>
                    <th>Sub</th>
                    <th>Score</th>
                    <th>Facts (comma-separated)</th>
                    <th>Actions</th>
                </tr>
            `;
            for (const [username, user_data] of Object.entries(data)) {
                // Parse facts if they are stored as JSON string, or default to empty list
                let userFacts = [];
                try {
                    if (user_data.facts) {
                        userFacts = JSON.parse(user_data.facts);
                    }
                } catch(e) { console.error("Error parsing facts", e); }
                const factsString = userFacts.join(", ");

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${username}</td>
                    <td>${user_data.message_count}</td>
                    <td>${user_data.is_subscriber ? 'Yes' : 'No'}</td>
                    <td><input type="number" value="${user_data.favouritism_score}" id="favouritism-score-${username}" style="width: 50px;"></td>
                    <td><textarea id="facts-${username}" style="width: 100%; height: 50px;">${factsString}</textarea></td>
                    <td>
                        <button onclick="updateUserData('${username}')">Save</button>
                    </td>
                `;
                table.appendChild(row);
            }
            userExplorerContainer.appendChild(table);
        });

        function updateUserData(username) {
            // Update Score
            const scoreInput = document.getElementById(`favouritism-score-${username}`);
            const score = parseInt(scoreInput.value);
            socket.emit("update_favouritism_score", {username: username, score: score});

            // Update Facts
            const factsInput = document.getElementById(`facts-${username}`);
            const factsList = factsInput.value.split(",").map(f => f.trim()).filter(f => f);
            socket.emit("update_user_facts", {username: username, facts: factsList});
        }

        function saveConversationStarterSettings() {
            const conversationStarter = {
                enabled: conversationStarterCheckbox.checked,
                interval: parseInt(conversationStarterIntervalInput.value)
            };
            socket.emit("update_conversation_starter_settings", {conversation_starter: conversationStarter});
        }

        socket.on("connect", () => {
            addLog("Connected to server.");
        });

        socket.on("disconnect", () => {
            addLog("Disconnected from server.");
        });

        // Live Context Monitoring
        setInterval(() => {
            socket.emit("get_live_context");
        }, 1000);

        const chatLogsDiv = document.getElementById("chat-logs");
        const captionLogsDiv = document.getElementById("caption-logs");

        socket.on("live_context_update", (data) => {
            function updateLog(container, contentBuilder) {
                const wasAtBottom = container.scrollHeight - container.scrollTop === container.clientHeight;

                // Save current selection if any
                // Note: Rebuilding innerHTML clears selection, but for this simple dashboard it's acceptable vs complex diffing

                container.innerHTML = "";
                contentBuilder(container);

                if (wasAtBottom) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            updateLog(chatLogsDiv, (container) => {
                if (data.chat_history) {
                    data.chat_history.forEach(entry => {
                        const div = document.createElement("div");
                        const userStrong = document.createElement("strong");
                        userStrong.textContent = entry.user + ": ";

                        const messageSpan = document.createElement("span");
                        messageSpan.textContent = entry.message;

                        const br = document.createElement("br");

                        const botEm = document.createElement("em");
                        botEm.textContent = "Bot: ";

                        const responseSpan = document.createElement("span");
                        responseSpan.textContent = entry.response;

                        const hr = document.createElement("hr");

                        div.appendChild(userStrong);
                        div.appendChild(messageSpan);
                        div.appendChild(br);
                        div.appendChild(botEm);
                        div.appendChild(responseSpan);
                        div.appendChild(hr);

                        container.appendChild(div);
                    });
                }
            });

            updateLog(captionLogsDiv, (container) => {
                 if (data.captions) {
                    data.captions.forEach(line => {
                        const div = document.createElement("div");
                        div.textContent = line;
                        container.appendChild(div);
                    });
                }
            });
        });
    </script>
</body>
</html>
